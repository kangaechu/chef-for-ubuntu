#!/bin/sh

# Symlink EBS uploads, gitlab needs to be cloned
sudo ln -s /mnt/ebs/uploads /home/gitlab/gitlab/public/uploads
sudo chown -R gitlab:gitlab /home/gitlab/gitlab/public/uploads
sudo chmod -R 755 /home/gitlab/gitlab/public/uploads

# Copy in Gitlab config
sudo mv /home/ubuntu/gitlab.yml /home/gitlab/gitlab/config/gitlab.yml
sudo chmod 644 /home/gitlab/gitlab/config/gitlab.yml
sudo chown gitlab:gitlab /home/gitlab/gitlab/config/gitlab.yml

# Install Gitlab gems, somethings fails due to network so try two times.
sudo su -l gitlab -c "cd gitlab && bundle install --without development test --deployment"
sudo su -l gitlab -c "cd gitlab && bundle install --without development test --deployment"

# Setup gitlab hooks
sudo cp /home/gitlab/gitlab/lib/hooks/post-receive /home/git/.gitolite/hooks/common/post-receive
sudo chown git:git /home/git/.gitolite/hooks/common/post-receive

# Tighten gitolite permissions
sudo -u git chmod 750 /home/git/gitolite

# Tighten gitlab config permissions
sudo -u gitlab chmod 660 /home/gitlab/gitlab/config/*.yml

# Configure Unicorn
sudo -u gitlab cp /home/gitlab/gitlab/config/unicorn.rb.example /home/gitlab/gitlab/config/unicorn.rb

# Create a Gitlab service
sudo wget https://raw.github.com/gitlabhq/gitlab-recipes/master/init.d/gitlab -P /etc/init.d/
sudo chmod +x /etc/init.d/gitlab && sudo update-rc.d gitlab defaults

# Go to gitlab directory by default on next login.
echo 'cd /home/gitlab/gitlab' >> /home/ubuntu/.bashrc
